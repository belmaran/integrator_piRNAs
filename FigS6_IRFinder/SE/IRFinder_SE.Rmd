---
title: "IRFinder_SE"
author: "Toni Beltran"
date: "01/02/2020"
output: html_document
---

```{r setup}

library(reshape2)
library(ggplot2)
library(scales)

setwd("/Users/ab6415/Bioinformatics/Analysis/INTEGRATOR_PAPER_ANALYSES/SuppFig6_IRFinder//SE")

path_IRfiles<-"/Users/ab6415/Bioinformatics/Analysis/INTEGRATOR_PAPER_ANALYSES/SuppFig6_IRFinder/SE/"
IR_files<- list.files(path=path_IRfiles, pattern="*001") 
IR_files<-paste0(path_IRfiles,IR_files)
names <-c("N2_EV1","N2_EV2","N2_RNAi1","N2_RNAi2","total","TFIIS_EV2","TFIIS_RNAi1","TFIIS_RNAi2")
          
IR_data <- lapply(IR_files,function(i){
  read.table(file=i, header=TRUE,sep="\t")
})
colnames(IR_data[[1]])
table(IR_data[[1]][21])
hist(unlist(IR_data[[1]][8]))

squash_axis <- function(from, to, factor) { 
    # A transformation function that squashes the range of [from, to] by factor on a given axis 

    # Args:
    #   from: left end of the axis
    #   to: right end of the axis
    #   factor: the compression factor of the range [from, to]
    #
    # Returns:
    #   A transformation called "squash_axis", which is capsulated by trans_new() function

  trans <- function(x) {    
      # get indices for the relevant regions
      isq <- x > from & x < to
      ito <- x >= to

      # apply transformation
      x[isq] <- from + (x[isq] - from)/factor
      x[ito] <- from + (to - from)/factor + (x[ito] - to)

      return(x)
  }

  inv <- function(x) {

      # get indices for the relevant regions
      isq <- x > from & x < from + (to - from)/factor
      ito <- x >= from + (to - from)/factor

      # apply transformation
      x[isq] <- from + (x[isq] - from) * factor
      x[ito] <- to + (x[ito] - (from + (to - from)/factor))

      return(x)
  }

# return the transformation
  return(trans_new("squash_axis", trans, inv))
}


#all genes
plot_IR<-function(dflist,outfilename){
  irs<-cbind(unlist(dflist[[1]][20]),rep(names[1],nrow(dflist[[1]][20])))
  for (i in seq(2:(length(dflist)+1))){
    dat<-cbind(unlist(dflist[[i]][20]),rep(names[i],nrow(dflist[[i]][20])))
    irs<-rbind(irs,dat)
  }
  rownames(irs)<-NULL
  irs<-data.frame(IR=as.numeric(irs[,1]),sample=as.factor(irs[,2]))
  print(ggplot(irs,aes(x=sample,y=IR))+geom_violin(bw=0.01)+geom_boxplot(width=0.1,outlier.shape = NA)+theme_classic()+
    scale_y_continuous(trans=squash_axis(0.25,1,3)))
  ggsave(outfilename)
  print(ggplot(irs,aes(x=sample,y=log10(IR+1e-5)))+geom_violin(bw=0.1)+geom_boxplot(width=0.1,outlier.shape = NA)+theme_classic())
  print(ggplot(irs,aes(x=sample,y=log10(IR+1e-5)))+geom_boxplot()+theme_classic())
}

#all genes
plot_IR(IR_data,"IR_ratios_allgenes.pdf")

#filter out zero IR
IR_data_nozero<-lapply(IR_data,function(df){return(df[-which(df$IRratio==0),])})
plot_IR(IR_data_nozero,"IR_ratios_nozeroIRgenes.pdf")





```