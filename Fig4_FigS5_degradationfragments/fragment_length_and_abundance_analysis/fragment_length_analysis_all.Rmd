---
title: "length_distribution_fragments.Rmd"
author: "Toni Beltran"
date: "01/02/2020"
output: html_document
---

## Degradation fragment length distributions

Here I plot the length distributions of degradation fragments corresponding to the second peak - 5Â´P ends mapping from +25 to +50 of 21U-RNA.

```{r plot fragment length distributions}

setwd("/Users/ab6415/Bioinformatics/Analysis/INTEGRATOR_PAPER_ANALYSES/Fig4_FigS5_degradationfragments/fragment_length_and_abundance_analysis/")
library(ggplot2)
library(dplyr)
library(reshape2)

path_files<-"/Users/ab6415/Bioinformatics/Analysis/INTEGRATOR_PAPER_ANALYSES/Fig4_FigS5_degradationfragments/fragment_length_and_abundance_analysis/"
files<- list.files(path=path_files, pattern="*distance") 
files<-paste0(path_files,files)
names <-c("N2_EV2","N2_ints11_RNAi2","TFIIS_EV2","N2_EV1","TFIIS_ints11_RNAi2","N2_ints11_RNAi1","TFIIS_EV1","TFIIS_ints11_RNAi1")
          
data <- lapply(files,function(i){
  read.table(file=i,sep="\t")
})


plot_hist<-function(df){
        df<-df[which(df$V15<100),]
        print(ggplot(df)+
            geom_histogram(aes(x=V15),breaks=seq(100))+
            ggtitle(names[i])+
            xlab("distance from piRNA 5'U")+
            theme_classic())
}
                                
for (i in seq(length(names))){
  plot_hist(data[[i]])
}
  
 
data_25_to_50<-lapply(data,function(df){return(df[which(df$V15>24 & df$V15<50),])})


DF_all<-data.frame()

for (i in seq(length(names))){
  df<-data_25_to_50[[i]]
  df$sample<-rep(names[i],nrow(df))
  DF_all<-rbind(DF_all,df)
}

ggplot(DF_all)+geom_boxplot(aes(y=V4,x=sample,fill=sample))+ylab("fragment length")
ggplot(DF_all)+geom_violin(aes(y=V4,x=sample,fill=sample,color=sample))+ylab("fragment length")



histogram_for_multiple_samples<-function(dflist,indices,title){
   
  length.mlt <- melt(lapply(dflist,function(df){return(df$V4)}))
  length.mlt$L1 <- as.numeric(length.mlt$L1)
  length.mlt$sample <- names[length.mlt$L1]
  
  length.mlt <- length.mlt[which(length.mlt$L1 %in% indices),]
  length.mlt$L1 <- as.factor(length.mlt$L1)
  
  kernel_1<-density(length.mlt[which(length.mlt$L1 == levels((length.mlt$L1))[1]),"value"])
  kernel_2<-density(length.mlt[which(length.mlt$L1 == levels((length.mlt$L1))[2]),"value"])
  
  max_1<-kernel_1$x[which(diff(sign(diff(kernel_1$y)))==-2)+1]
  max_2<-kernel_2$x[which(diff(sign(diff(kernel_2$y)))==-2)+1]
  
  print(max_1)
  print(max_2)
  
  linedata<-data.frame(xvar1=kernel_1$x,xvar2=kernel_2$x,yvar1=kernel_1$y,yvar2=kernel_2$y)
  
  print(ggplot(length.mlt, aes(value, fill=sample)) + 
    geom_histogram(aes(y = ..density..), position = 'identity',breaks=seq(0,50),alpha=0.5)+
    theme_classic()+
    scale_fill_manual(values = c("orange","lightblue"))+
    ggtitle(title)+xlab("fragment length")+ylab("fraction of sequences")+
    coord_cartesian(xlim=c(0,50))+
    geom_line(data=linedata,aes(x=linedata$xvar1,y=linedata$yvar1,fill=names[indices[1]]),col="orange")+
    geom_line(data=linedata,aes(x=linedata$xvar2,y=linedata$yvar2,fill=names[indices[2]]),col="lightblue"))
}

histogram_for_multiple_samples(data_25_to_50,c(1,2),"N2_EV1 vs N2_ints11RNAi1")
histogram_for_multiple_samples(data_25_to_50,c(1,3),"N2_EV1 vs TFIIS_EV1")
histogram_for_multiple_samples(data_25_to_50,c(1,5),"N2_EV1 vs TFIIS_ints11RNAi1")
histogram_for_multiple_samples(data_25_to_50,c(4,6),"N2_EV2 vs N2_ints11RNAi2")
histogram_for_multiple_samples(data_25_to_50,c(4,7),"N2_EV2 vs TFIIS_EV2")
histogram_for_multiple_samples(data_25_to_50,c(4,8),"N2_EV2 vs TFIIS_ints11RNAi2")



histogram_for_multiple_samples_weightedavg_densityfit<-function(dflist,indices,title){
  
  length.mlt <- melt(lapply(dflist,function(df){return(df$V4)}))
  length.mlt$L1 <- as.numeric(length.mlt$L1)
  length.mlt <- length.mlt[which(length.mlt$L1 %in% indices),]

  length.mlt[which(length.mlt$L1==indices[2]),"L1"]<-indices[1]
  length.mlt[which(length.mlt$L1==indices[4]),"L1"]<-indices[3]
  
  length.mlt$sample <- names[length.mlt$L1]
  length.mlt$L1 <- as.factor(length.mlt$L1)

  a<-hist(length.mlt[which(length.mlt$L1 == levels((length.mlt$L1))[1]),"value"],plot = FALSE,breaks = seq(130))
  b<-hist(length.mlt[which(length.mlt$L1 == levels((length.mlt$L1))[2]),"value"],plot = FALSE,breaks = seq(130))
  
  kernel_1<-density(length.mlt[which(length.mlt$L1 == levels((length.mlt$L1))[1]),"value"])
  max_1<-kernel_1$x[which(diff(sign(diff(kernel_1$y)))==-2)+1]
  
  kernel_2<-density(length.mlt[which(length.mlt$L1 == levels((length.mlt$L1))[2]),"value"])
  max_2<-kernel_2$x[which(diff(sign(diff(kernel_2$y)))==-2)+1]
  
  print(max_1)
  print(max_2)
  
  linedata<-data.frame(xvar1=kernel_1$x,xvar2=kernel_2$x,yvar1=kernel_1$y,yvar2=kernel_2$y)
  
  print(ggplot(length.mlt, aes(value, fill=sample)) + 
    geom_histogram(aes(y = ..density..), position = 'identity',breaks=a$breaks,alpha=0.5)+
    theme_classic()+
    scale_fill_manual(values = c("orange","lightblue"))+
    ggtitle(title)+xlab("fragment length")+ylab("fraction of sequences")+
    coord_cartesian(c(0,50))+
    geom_line(data=linedata,aes(x=linedata$xvar1,y=linedata$yvar1,fill=names[indices[1]]),col="orange")+
    geom_line(data=linedata,aes(x=linedata$xvar2,y=linedata$yvar2,fill=names[indices[3]]),col="lightblue"))
}


histogram_for_multiple_samples_weightedavg_densityfit(data_25_to_50,c(1,4,2,6),"N2_EV vs N2_ints11RNAi")
ggsave("N2_EV_vs_N2_ints11RNAi_fragmentlength.pdf")
histogram_for_multiple_samples_weightedavg_densityfit(data_25_to_50,c(1,4,3,7),"N2_EV vs TFIIS_EV")
ggsave("N2_EV_vs_TFIIS_EV_fragmentlength.pdf")
histogram_for_multiple_samples_weightedavg_densityfit(data_25_to_50,c(1,4,5,8),"N2_EV vs TFIIS_ints11RNAi")
ggsave("N2_EV_vs_TFIIS_ints11RNAi_fragmentlength.pdf")



```

